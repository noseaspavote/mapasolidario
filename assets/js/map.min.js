function getAjaxPromise(e,a){return $.ajax({url:$("body").data("site-url")+e,dataType:"json",async:a,method:"get"}).fail(function(){})}function getFreeGeoIpData(){$.ajax({url:"http://freegeoip.net/json",dataType:"jsonp",async:!0,method:"get"}).fail(function(){}).done(function(e){console.log(e)})}function initMap(){var e=-34.766667,a=-58.4,r=14,t=$("#showll").val().split(",");2==t.length&&(e=parseFloat(t[0]),a=parseFloat(t[1]),r=18),mapCanvas=L.map("map-canvas",{visualClickEvents:"dblclick"}).setView([e,a],r),2==t.length&&positionMarker([e,a]),L.tileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{transparent:!0,tiled:!0,attribution:'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://www.noseaspavote.org.ar">NoSeasPavote</a>'}).addTo(mapCanvas),_turkeyIcon=new L.icon({iconUrl:$("body").data("site-url")+"assets/media/img/marker-turkey.png",iconSize:[34,35],popupAnchor:[12,-20]});var o=getAjaxPromise("api/categories",!1);o.done(function(e){loadCategories(e),1==$("#link-announcement").data("show-on-load")&&$("#link-announcement").trigger("click"),loadMarkers()})}function loadCategories(e){_categories=e,$(".category-template-container").loadTemplate("#category-template",_categories)}function getLayerByCategory(e){var a=null;return $.each(_layers,function(r,t){t.category_id==e&&(a=t.layer)}),a}function setupMarker(e,a){var r=new L.icon({iconUrl:$("body").data("site-url")+"assets/media/img/"+e.properties.icon,iconSize:[34,46],popupAnchor:[12,-20]});a.setIcon(r);var t;""!=e.properties.alias?t=$("body").data("site-url")+"institucion/alias/"+e.properties.alias:""!=e.properties.code&&(t=$("body").data("site-url")+"institucion/code/"+e.properties.code);var o="<div>";o=o+"<b>"+e.properties.name+"</b><br />",o=o+"Dirección: "+e.properties.street_name+" "+e.properties.street_number+"<br />",o+="<br />",o+=""===e.properties.description||null==e.properties.description?"":"<span>"+e.properties.description+"</span><br />",o+="<br />",o+='<span style="float:left;">',o=o+'Fuente: <a href="'+e.properties.source_site_url+'" target="_blank" title="'+e.properties.source_description+'">'+e.properties.source_name+"</a>",o+="</span>",o+="<br />",o+='<span style="float:right;">',o=o+'<a href="'+t+'" title="Conocer más">[conocer más]</a>',o+="</span>",o+="<br />",o+="</div>",a.bindPopup(o);var n=$("#showInstitution").val().toUpperCase();""!=n&&(e.properties.alias==n?_queryMarker=a:e.properties.id==n&&(_queryMarker=a))}function loadMarkers(){$(_categories).each(function(e,a){var r=getAjaxPromise("api/markers.geojson/category/"+a.id,!1),t={category_id:a.id,layer:[]};r.done(function(e){var a=L.geoJson(e,{onEachFeature:setupMarker}).addTo(mapCanvas);t.layer=a,_layers.push(t),_queryMarker&&(_queryMarker.openPopup(),mapCanvas.setView(_queryMarker.getLatLng(),18))})})}function useCurrentLocation(){mapCanvas.on("locationfound",onLocationFound),mapCanvas.on("locationerror",onLocationError),mapCanvas.locate({setView:!0,maxZoom:16})}function onLocationFound(e){L.marker(e.latlng,{icon:_turkeyIcon}).addTo(mapCanvas).bindPopup("<b>Estás aquí!</b>").openPopup()}function onLocationError(e){console.log(e.message)}function setCategoryMarkers(e){var a=$(e).prev().val();$(e).find("i").toggleClass("fa-check-square"),$(e).find("i").toggleClass("fa-square"),1==$(e).data("selected")?(mapCanvas.removeLayer(getLayerByCategory(a)),$(e).data("selected",!1)):(mapCanvas.addLayer(getLayerByCategory(a)),$(e).data("selected",!0))}function setAllCategories(){$(".category-template-container").find("a").each(function(){0==$(this).data("selected")&&$(this).trigger("click")})}function showInfo(e){var a=$(e).prev().val();mapCanvas.eachLayer(function(e){e.hasOwnProperty("feature")&&e.feature.hasOwnProperty("properties")&&e.feature.properties.id==a&&e.openPopup()})}function search(){var e=$("#txtSearch").val();if(""!=e){$(".leaflet-control-zoom").css("visibility","hidden");var a=getAjaxPromise("api/markers/q/"+encodeURIComponent(e),!0);a.done(function(e){_markers=e,_markers.length>0?($(".form__list").show(),$(".form--search__result").loadTemplate("#result-template",_markers)):$(".form__list").hide()})}}function positionMarker(e){L.marker(e).addTo(mapCanvas)}var mapCanvas,_categories=[],_layers=[],_layerDummy,_turkeyIcon,_queryMarker;$(document).ready(function(){$(document).on("keypress","#txtSearch",function(e){return 13==e.which?(search(),!1):void 0}),$(document).on("click","#btnSearch",function(){return search(),!1}),$(document).on("click",".form__close",function(){return $(".form__list").hide(),$(".leaflet-control-zoom").css("visibility","visible"),!1}),initMap()});